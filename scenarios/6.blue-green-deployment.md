# Scenario: Blue-Green Deployment

## Goal

Learn how to implement blue-green deployments with Argo CD using simple Kubernetes manifests.

## What is Blue-Green Deployment?

Blue-Green deployment:
- Runs two identical environments (Blue and Green)
- Only one serves traffic at a time
- Switch traffic instantly by updating the service selector
- Easy rollback by switching back
- Zero downtime, instant cutover

## Setup

We'll create two separate deployments and switch traffic between them.

1. **Create the Blue deployment**:
   
   Create `app/deployment-blue.yaml`:
   ```yaml
   apiVersion: apps/v1
   kind: Deployment
   metadata:
     name: demo-app-blue
     namespace: demo
   spec:
     replicas: 2
     selector:
       matchLabels:
         app: demo-app
         version: blue
     template:
       metadata:
         labels:
           app: demo-app
           version: blue
       spec:
         containers:
         - name: nginx
           image: nginx:1.25
           ports:
           - containerPort: 80
   ```

2. **Create the Green deployment**:
   
   Create `app/deployment-green.yaml`:
   ```yaml
   apiVersion: apps/v1
   kind: Deployment
   metadata:
     name: demo-app-green
     namespace: demo
   spec:
     replicas: 2
     selector:
       matchLabels:
         app: demo-app
         version: green
     template:
       metadata:
         labels:
           app: demo-app
           version: green
       spec:
         containers:
         - name: nginx
           image: nginx:1.26
           ports:
           - containerPort: 80
   ```

3. **Update the service to point to Blue**:
   
   Edit `app/service.yaml`:
   ```yaml
   apiVersion: v1
   kind: Service
   metadata:
     name: demo-service
     namespace: demo
   spec:
     type: NodePort
     selector:
       app: demo-app
       version: blue  # Currently serving Blue
     ports:
     - port: 80
       targetPort: 80
       nodePort: 30080
   ```

4. **Remove the old deployment.yaml**:
   ```bash
   git rm app/deployment.yaml
   ```

5. **Commit and push**:
   ```bash
   git add app/
   git commit -m "Setup blue-green deployment"
   git push
   ```

## Steps to Switch from Blue to Green

1. **Verify Blue is serving traffic**:
   ```bash
   kubectl get pods -n demo -l version=blue
   kubectl get pods -n demo -l version=green
   curl http://$(minikube ip):30080
   ```

2. **Switch traffic to Green**:
   
   Edit `app/service.yaml` and change the selector:
   ```yaml
   selector:
     app: demo-app
     version: green  # Now serving Green
   ```

3. **Commit and push**:
   ```bash
   git add app/service.yaml
   git commit -m "Switch traffic to Green"
   git push
   ```

4. **Watch Argo CD sync**:
   - Open Argo CD UI
   - Watch the sync happen
   - Traffic switches instantly

5. **Verify Green is now serving**:
   ```bash
   kubectl get endpoints demo-service -n demo -o yaml
   curl http://$(minikube ip):30080
   ```

## Instant Rollback

If Green has issues, rollback is instant:

```bash
# Edit service.yaml back to version: blue
git add app/service.yaml
git commit -m "Rollback to Blue"
git push
```

Traffic switches back immediately!

## Expected Argo CD Behavior

- Both Blue and Green deployments run simultaneously
- Service update syncs instantly
- No pod restarts needed
- Traffic switches at the service layer
- Both versions remain ready for quick switching

## Learning Outcome

**Blue-Green = Instant Cutover**

Advantages:
- Zero downtime
- Instant rollback
- Test Green in production before switching
- Clean separation of versions

Disadvantages:
- Requires double resources (both environments running)
- Database migrations can be tricky
- More complex manifest management

## Cleanup

When Green is stable, you can scale down Blue:
```yaml
# In deployment-blue.yaml
spec:
  replicas: 0
```

Or delete Blue entirely:
```bash
git rm app/deployment-blue.yaml
git commit -m "Remove Blue deployment"
git push
```
